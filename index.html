<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™¼ç²’å­ - è±¡æ£‹ç·šä¸Šå°æˆ°å¹³å°</title>
    <style>
        :root { --bg: #0a0a0a; --text: #dcdcdc; --accent: #ff3e3e; --valid: #00ff88; --gold: #ffd700; --card-bg: #1a1a1a; }
        body { font-family: "Segoe UI", "PingFang TC", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .hidden { display: none; }
        #game { width: 100%; max-width: 600px; }

        /* è±¡æ£‹é¢¨æ ¼ */
        .piece { display: inline-block; width: 44px; height: 44px; line-height: 44px; border: 2px solid #444; border-radius: 50%; margin: 4px; cursor: pointer; background: #222; font-weight: bold; font-size: 1.2rem; text-align: center; position: relative; transition: all 0.2s; user-select: none; }
        .piece.red { color: #ff5252; border-color: #ff5252; }
        .piece.black { color: #bbb; border-color: #777; }
        .piece.selected { border-color: var(--gold); transform: translateY(-8px); box-shadow: 0 5px 15px rgba(255,215,0,0.4); }
        .piece.covered { background: #333; color: #333; }

        /* ä½ˆå±€å€å¡Š */
        .phase-container { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .table-area { min-height: 100px; background: #000; border-radius: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; border: 2px solid #222; margin: 10px 0; }
        .card-slot { border-bottom: 1px solid #222; padding: 5px; min-height: 60px; }
        
        .score-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .score-box { background: #111; padding: 8px; border-radius: 8px; text-align: center; border-bottom: 2px solid var(--accent); font-size: 0.8rem; }
        
        .hint-text { color: var(--gold); font-size: 0.8rem; height: 20px; margin-top: 5px; font-weight: bold; }
        .log { height: 100px; overflow-y: auto; background: #000; font-size: 0.75rem; padding: 8px; color: #0f0; border: 1px solid #222; }
        
        button { background: #222; color: #fff; border: 1px solid #444; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 4px; }
        button.primary { background: var(--accent); border: none; }
        button:disabled { opacity: 0.2; cursor: not-allowed; }
        .sort-btn { font-size: 0.7rem; padding: 5px 10px; background: #333; border-color: #555; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color:var(--accent); letter-spacing:8px;">ç™¼ç²’å­</h1>
        <p style="color:#666">QUANTUM PARTICLE SYSTEM v1.5</p>
        <div style="margin-top:30px">
            <button onclick="join(1)">P1 (ç•¶å®¶)</button>
            <button onclick="join(2)">P2</button>
            <button onclick="join(3)">P3</button>
            <button onclick="join(4)">P4</button>
        </div>
    </div>

    <div id="game" class="hidden">
        <div class="score-row" id="score-ui"></div>

        <div id="counting-phase" class="phase-container hidden">
            <h3>ğŸ² é–‹å±€æŒ‡é‹</h3>
            <p>è«‹å‡ºæ•¸å­— (0-10)ï¼š</p>
            <input type="number" id="finger-num" min="0" max="10" value="0" style="width:60px; padding:10px; background:#222; color:#fff; border:1px solid #444;">
            <button class="primary" onclick="submitFinger()">é€å‡ºæ•¸å­—</button>
            <div id="counting-status" style="margin-top:10px; font-size:0.8rem; color:#888;"></div>
        </div>

        <div class="table-area" id="table">
            <div class="card-slot" id="slot-p1"><small>P1</small><div class="cards"></div></div>
            <div class="card-slot" id="slot-p2"><small>P2</small><div class="cards"></div></div>
            <div class="card-slot" id="slot-p3"><small>P3</small><div class="cards"></div></div>
            <div class="card-slot" id="slot-p4"><small>P4</small><div class="cards"></div></div>
        </div>

        <div id="action-ui" class="phase-container">
            <div id="pattern-hint" class="hint-text"></div>
            
            <div id="head-controls" class="hidden">
                <button class="primary" id="btn-head-play" onclick="headPlay(false)">æŠ•æ”¾ç²’å­ (é–‹ç‰Œ)</button>
                <button class="primary" id="btn-head-hide" onclick="headPlay(true)">æ‚¶ç‰ŒæŠ•æ”¾</button>
            </div>

            <div id="follow-controls" class="hidden">
                <p style="font-size:0.8rem">éœ€è·Ÿç‰Œæ•¸ï¼š<span id="need-count">0</span></p>
                <button class="primary" id="btn-follow-play" onclick="followPlay()">è“‹ç‰ŒæŠ•æ”¾</button>
            </div>

            <div id="reveal-controls" class="hidden">
                <button class="primary" onclick="revealDecision(true)">é–‹ç‰ŒæŒ‘æˆ°</button>
                <button onclick="revealDecision(false)">æ‚¶ç‰Œä¸é–‹</button>
            </div>
        </div>

        <div class="phase-container">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.7rem">ç²’å­æ‰‹ç‰Œ</span>
                <div>
                    <button class="sort-btn" onclick="sortHand('rank')">æŒ‰å¤§å°</button>
                    <button class="sort-btn" onclick="sortHand('pattern')">æŒ‰ç‰Œå‹</button>
                </div>
            </div>
            <div id="my-hand" style="margin-top:10px"></div>
            <button id="btn-start" class="hidden" onclick="initRound()" style="margin-top:10px; width:100%">é‡å•Ÿæ–°å±€</button>
        </div>

        <div class="log" id="log"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA15KzswwEHzY_jg2RvFV0T_CAD19EX7MY",
        authDomain: "hualiaba.firebaseapp.com",
        databaseURL: "https://hualiaba-default-rtdb.firebaseio.com",
        projectId: "hualiaba",
        appId: "1:1066537441904:web:1b5d1c5e4d1b987eb072b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'room1');

    let myID, myHand = [], selectedIdx = [], gameState = {};
    const rankMap = { "ç´…å¸¥":7, "ç´…ä»•":6, "ç´…ç›¸":5, "ç´…è»Š":4, "ç´…é¦¬":3, "ç´…ç‚®":2, "ç´…å…µ":1, "é»‘å°‡":6.5, "é»‘å£«":5.5, "é»‘è±¡":4.5, "é»‘è»Š":3.5, "é»‘é¦¬":2.5, "é»‘åŒ…":1.5, "é»‘å’":0.5 };

    window.join = (id) => {
        myID = `p${id}`;
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        document.getElementById('my-name').innerText = `P${id}`;
        if(id===1) document.getElementById('btn-start').classList.remove('hidden');
    };

    window.initRound = () => {
        const p = ["ç´…å¸¥","ç´…å¸¥","ç´…ä»•","ç´…ä»•","ç´…ç›¸","ç´…ç›¸","ç´…è»Š","ç´…è»Š","ç´…é¦¬","ç´…é¦¬","ç´…ç‚®","ç´…ç‚®","ç´…å…µ","ç´…å…µ","ç´…å…µ","ç´…å…µ","ç´…å…µ","é»‘å°‡","é»‘å°‡","é»‘å£«","é»‘å£«","é»‘è±¡","é»‘è±¡","é»‘è»Š","é»‘è»Š","é»‘é¦¬","é»‘é¦¬","é»‘åŒ…","é»‘åŒ…","é»‘å’","é»‘å’","é»‘å’","é»‘å’","é»‘å’"];
        const s = p.sort(() => Math.random() - 0.5);
        set(gameRef, {
            phase: "COUNTING", dealer: "p1", logs: ["é€²å…¥æŒ‡é‹ç’°ç¯€..."],
            p1_hand: s.slice(0,8), p2_hand: s.slice(8,16), p3_hand: s.slice(16,24), p4_hand: s.slice(24,32),
            table: {p1:null, p2:null, p3:null, p4:null}, scores: {p1:0, p2:0, p3:0, p4:0}, finger_picks: {}
        });
    };

    onValue(gameRef, (snap) => {
        const data = snap.val(); if(!data) return;
        gameState = data;
        myHand = data[`${myID}_hand`] || [];
        updateUI();
    });

    function updateUI() {
        const scores = gameState.scores || {p1:0, p2:0, p3:0, p4:0};
        document.getElementById('score-ui').innerHTML = [1,2,3,4].map(i => {
            const s = scores[`p${i}`];
            const bonus = s >= 32 ? 10 : 0;
            const diff = (s+bonus) - 80;
            return `<div class="score-box">P${i}<br><b>${s+bonus}</b><br><small>${diff>=0?'+'+diff:diff}</small></div>`;
        }).join('');

        document.getElementById('counting-phase').className = gameState.phase === "COUNTING" ? "phase-container" : "hidden";
        if(gameState.phase === "COUNTING") {
            const picks = gameState.finger_picks || {};
            const count = Object.keys(picks).length;
            document.getElementById('counting-status').innerText = `å·²é€å‡ºï¼š${count}/4`;
            if(count === 4 && myID === "p1") resolveHead();
        }

        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = myHand.map((p, i) => `<div class="piece ${p.includes('ç´…')?'red':'black'} ${selectedIdx.includes(i)?'selected':''}" onclick="togglePiece(${i})">${p[1]}</div>`).join('');

        [1,2,3,4].forEach(i => {
            const slot = document.querySelector(`#slot-p${i} .cards`);
            const pData = gameState.table[`p${i}`];
            slot.innerHTML = pData ? pData.cards.map(c => (pData.revealed || i == myID.slice(1)) ? `<div class="piece ${c.includes('ç´…')?'red':'black'}">${c[1]}</div>` : `<div class="piece covered">?</div>`).join('') : "";
        });

        const phase = gameState.phase;
        document.getElementById('head-controls').className = (phase === "HEAD_PLAYING" && myID === gameState.head) ? "" : "hidden";
        document.getElementById('follow-controls').className = (phase === "FOLLOW_PLAYING" && myID !== gameState.head && !gameState.table[myID]) ? "" : "hidden";
        if(phase === "FOLLOW_PLAYING") document.getElementById('need-count').innerText = gameState.table[gameState.head].cards.length;
        document.getElementById('reveal-controls').className = (phase === "REVEAL_DECISION" && myID !== gameState.head && gameState.table[myID] && !gameState.table[myID].revealed) ? "" : "hidden";
        
        document.getElementById('log').innerHTML = (gameState.logs || []).reverse().map(l => `<div>> ${l}</div>`).join('');
        detectPattern();
    }

    function detectPattern() {
        const hintEl = document.getElementById('pattern-hint');
        if(selectedIdx.length === 0) { hintEl.innerText = ""; return; }
        const sel = selectedIdx.map(i => myHand[i]);
        const count = sel.length;
        let hint = "éç‰Œå‹";
        const names = sel.map(s => s[1]).sort().join('');
        const isRed = sel.every(s => s.includes('ç´…'));

        if(count === 1) hint = "ç‰Œå‹ï¼šä¸€é¡†";
        else if(count === 2 && sel[0][1] === sel[1][1] && sel[0][0] === sel[1][0]) hint = "ç‰Œå‹ï¼šä¸€å°";
        else if(count === 3 && (names==="ä»•å¸¥ç›¸" || names==="å£«å°‡è±¡" || names==="åŒ…è»Šé¦¬")) hint = "ç‰Œå‹ï¼šä¸€å±€";
        else if(count >= 3 && sel.every(s => s[1]==="å…µ" || s[1]==="å’")) hint = "ç‰Œå‹ï¼šå…µå’çµ„";
        
        hintEl.innerText = hint;
        const btn = document.getElementById('btn-head-play');
        if(btn) btn.disabled = (hint === "éç‰Œå‹");
    }

    window.togglePiece = (i) => {
        const idx = selectedIdx.indexOf(i);
        if(idx > -1) selectedIdx.splice(idx, 1); else selectedIdx.push(i);
        updateUI();
    };

    window.sortHand = (type) => {
        if(type === 'rank') {
            myHand.sort((a,b) => rankMap[b] - rankMap[a]);
        } else {
            const order = {"å¸¥":1, "å°‡":1, "ä»•":2, "å£«":2, "ç›¸":3, "è±¡":3, "è»Š":4, "é¦¬":5, "ç‚®":6, "åŒ…":6, "å…µ":7, "å’":7};
            myHand.sort((a,b) => (order[a[1]] || 99) - (order[b[1]] || 99) || a[0].localeCompare(b[0]));
        }
        update(gameRef, { [`${myID}_hand`]: myHand });
    };

    window.submitFinger = () => {
        const val = parseInt(document.getElementById('finger-num').value);
        update(gameRef, { [`finger_picks/${myID}`]: val });
    };

    function resolveHead() {
        const sum = Object.values(gameState.finger_picks).reduce((a,b) => a+b, 0);
        const headID = `p${((sum - 1) % 4) + 1}`;
        update(gameRef, { phase: "HEAD_PLAYING", head: headID, logs: [...gameState.logs, `ç¸½å’Œ ${sum}ï¼Œé ­å®¶ï¼š${headID}`] });
    }

    window.headPlay = (isHidden) => {
        const cards = selectedIdx.map(i => myHand[i]);
        const newHand = myHand.filter((_, i) => !selectedIdx.includes(i));
        update(gameRef, { phase: "FOLLOW_PLAYING", [`table/${myID}`]: { cards, revealed: !isHidden }, [`${myID}_hand`]: newHand, logs: [...gameState.logs, `${myID} æŠ•æ”¾ç²’å­ ${isHidden?'(æ‚¶)':''}`] });
        selectedIdx = [];
    };

    window.followPlay = () => {
        const need = gameState.table[gameState.head].cards.length;
        if(selectedIdx.length !== need) return alert(`éœ€æŠ• ${need} å¼µ`);
        const cards = selectedIdx.map(i => myHand[i]);
        const newHand = myHand.filter((_, i) => !selectedIdx.includes(i));
        update(gameRef, { [`table/${myID}`]: { cards, revealed: false }, [`${myID}_hand`]: newHand }).then(() => {
            onValue(gameRef, (s) => {
                const d = s.val();
                if(d.table.p1 && d.table.p2 && d.table.p3 && d.table.p4 && d.phase === "FOLLOW_PLAYING") {
                    update(gameRef, { phase: "REVEAL_DECISION", [`table/${d.head}/revealed`]: true, logs: [...d.logs, "å…¨å“¡æŠ•æ”¾å®Œç•¢ï¼Œé–‹ç‰Œï¼"]});
                }
            }, {onlyOnce: true});
        });
        selectedIdx = [];
    };

    window.revealDecision = (res) => {
        update(gameRef, { [`table/${myID}/revealed`]: res }).then(() => {
            onValue(gameRef, (s) => {
                const d = s.val();
                let dc = 0; [1,2,3,4].forEach(i => { if(d.table[`p${i}`].revealed !== undefined && (i==d.head.slice(1) || d.table[`p${i}`].revealed !== null)) dc++; });
                if(dc === 4 && d.phase === "REVEAL_DECISION") resolveWinner(d);
            }, {onlyOnce: true});
        });
    };

    function getPower(cards) {
        const names = cards.map(c => c[1]).sort().join('');
        const isRed = cards.every(c => c.includes('ç´…'));
        if (names === "ä»•å¸¥ç›¸" || names === "å£«å°‡è±¡") return isRed ? 100 : 95; 
        if (names === "åŒ…è»Šé¦¬") return isRed ? 85 : 80; 
        if (cards.every(c => c[1] === "å…µ" || c[1] === "å’")) return 50 + cards.length;
        if (cards.length === 2 && cards[0][1] === cards[1][1] && cards[0][0] === cards[1][0]) return 40 + rankMap[cards[0]];
        return Math.max(...cards.map(c => rankMap[c]));
    }

    function resolveWinner(d) {
        let winner = d.head, max = -1;
        [1,2,3,4].forEach(i => {
            const pid = `p${i}`; const p = d.table[pid];
            if(p.revealed) {
                const pw = getPower(p.cards);
                if(pw > max) { max = pw; winner = pid; }
            }
        });
        const pts = d.table[d.head].cards.length * 4;
        const ns = {...d.scores}; ns[winner] += pts;
        setTimeout(() => {
            update(gameRef, { phase: "HEAD_PLAYING", head: winner, table: {p1:null, p2:null, p3:null, p4:null}, scores: ns, logs: [...d.logs, `${winner} å¥ªå¾— ${pts} åˆ†ï¼`] });
        }, 1500);
    }
</script>
</body>
</html>
