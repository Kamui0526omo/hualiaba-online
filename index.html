<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™¼ç²’å­ v6.3 - æ£‹åŠ›ç²¾ä¿®ç‰ˆ</title>
    <style>
        :root { --bg: #050505; --text: #dcdcdc; --accent: #ff3e3e; --gold: #ffd700; --card-bg: #151515; --table-green: #0a2d0a; }
        body { font-family: "Consolas", "Microsoft JhengHei", monospace; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .hidden { display: none !important; }

        /* 3D é€è¦–æ¡Œå‹ */
        .table-wrap { perspective: 1000px; margin-top: 10px; }
        .mahjong-table {
            position: relative; width: 300px; height: 280px;
            background: var(--table-green); border: 14px solid #1a1a1a;
            border-radius: 25px; transform: rotateX(38deg);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9), 0 30px 60px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
        }

        /* è¦–è§’èˆ‡ä¸‰è§’å½¢æŒ‡ç¤ºç‡ˆ */
        .view-slot { position: absolute; width: 140px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; }
        .slot-bottom { bottom: 0; left: 50%; transform: translateX(-50%) translateZ(1px); }
        .slot-left { left: -10px; top: 50%; transform: translateY(-50%) rotateY(15deg) translateZ(1px); }
        .slot-top { top: 0; left: 50%; transform: translateX(-50%) translateZ(1px); }
        .slot-right { right: -10px; top: 50%; transform: translateY(-50%) rotateY(-15deg) translateZ(1px); }
        
        .indicator-triangle {
            position: absolute; width: 60px; height: 40px;
            background: rgba(255, 215, 0, 0); transition: 0.2s;
            pointer-events: none; opacity: 0;
        }
        .slot-bottom .indicator-triangle { bottom: 10px; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .slot-left .indicator-triangle { left: 10px; clip-path: polygon(100% 50%, 0% 0%, 0% 100%); }
        .slot-top .indicator-triangle { top: 10px; clip-path: polygon(50% 100%, 0% 0%, 100% 0%); }
        .slot-right .indicator-triangle { right: 10px; clip-path: polygon(0% 50%, 100% 0%, 100% 100%); }

        .active-area .indicator-triangle { 
            background: linear-gradient(to top, rgba(255,215,0,0.9), rgba(255,215,0,0.2));
            box-shadow: 0 0 30px var(--gold); opacity: 1;
        }

        /* æ£‹å­è¦–è¦ºä¿®æ­£ï¼šæ‰¾å›ç´…è‰² */
        .piece-base { width: 34px; height: 34px; line-height: 34px; border-radius: 50%; text-align: center; font-weight: bold; position: relative; display: inline-block; box-shadow: 0 4px 6px rgba(0,0,0,0.6); }
        .piece-base.red { color: #ff3333; border: 2px solid #8b0000; background: #1a0505; text-shadow: 0 0 8px rgba(255, 51, 51, 0.5); }
        .piece-base.black { color: #bbb; border: 2px solid #444; background: #111; }
        .piece-base.covered { background: #222; color: #222; border-color: #333; }

        .hand-piece { 
            position: absolute; width: 52px; height: 52px; line-height: 52px; border-radius: 50%; 
            cursor: pointer; font-weight: bold; font-size: 1.4rem; text-align: center; 
            transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); box-shadow: 0 6px 10px rgba(0,0,0,0.6);
        }
        .hand-piece.red { color: #ff3333; border: 3px solid #8b0000; background: #1a0505; text-shadow: 0 0 10px rgba(255, 51, 51, 0.6); }
        .hand-piece.black { color: #bbb; border: 3px solid #444; background: #111; }
        .hand-piece.selected { border-color: var(--gold); box-shadow: 0 0 30px var(--gold); z-index: 200; }

        .table-center-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) translateZ(45px); font-size: 3.5rem; font-weight: 900; color: var(--gold); text-shadow: 0 0 25px var(--gold); pointer-events: none; }
        .dealer-badge { position: absolute; top: 5px; right: 5px; width: 26px; height: 26px; line-height: 26px; background: var(--accent); color: #fff; font-size: 0.75rem; font-weight: bold; border-radius: 4px; text-align: center; border: 1.5px solid var(--gold); z-index: 10; }

        .bottom-action-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; width: 100%; margin-top: 15px; }
        button { background: #1a1a1a; color: #fff; border: 1px solid #444; padding: 12px 18px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        button.action-glow { background: var(--gold); color: #000; border: none; box-shadow: 0 0 20px var(--gold); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.04); } 100% { transform: scale(1); } }

        .score-box { background: #111; padding: 6px; border-radius: 8px; text-align: center; border-bottom: 3px solid var(--accent); font-size: 0.7rem; }
        .status-msg { color: var(--gold); font-size: 0.95rem; font-weight: bold; margin: 15px 0; min-height: 1.5rem; text-align: center; }
    </style>
</head>
<body>
    <div id="lobby">
        <h1 style="color:var(--accent); letter-spacing:10px; margin: 40px 0;">ç™¼ç²’å­</h1>
        <div id="seat-selection" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <button onclick="join(1)">P1 (å—)</button><button onclick="join(2)">P2 (æ±)</button>
            <button onclick="join(3)">P3 (åŒ—)</button><button onclick="join(4)">P4 (è¥¿)</button>
        </div>
        <button onclick="forceCleanDatabase()" style="margin-top:40px; color:#444; font-size:0.6rem; background:none; border:none; text-decoration: underline;">ğŸ”¥ é‡ç½®ä¼ºæœå™¨</button>
    </div>

    <div id="game" class="hidden">
        <div class="score-row" id="score-ui" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%;"></div>
        
        <div class="table-wrap">
            <div class="mahjong-table" id="main-table">
                <div class="view-slot slot-bottom" id="view-bottom"><div class="indicator-triangle"></div><div class="cards-container"></div></div>
                <div class="view-slot slot-left" id="view-left"><div class="indicator-triangle"></div><div class="cards-container"></div></div>
                <div class="view-slot slot-top" id="view-top"><div class="indicator-triangle"></div><div class="cards-container"></div></div>
                <div class="view-slot slot-right" id="view-right"><div class="indicator-triangle"></div><div class="cards-container"></div></div>
                <div id="center-num" class="table-center-display"></div>
                <div id="dealer-badge" class="dealer-badge hidden">èŠ</div>
            </div>
        </div>

        <div class="status-msg" id="diag-msg"></div>

        <div id="counting-phase" class="hidden" style="text-align:center; margin-bottom:15px;">
            <input type="number" id="finger-num" min="0" max="10" value="0" style="width:60px; padding:10px; background:#000; color:#fff; border:2px solid var(--gold); font-size:1.5rem; text-align:center; border-radius:10px;">
            <button class="action-glow" onclick="submitFinger()" style="margin-left:10px;">ç¢ºèª</button>
        </div>

        <div class="hand-arc-container" id="hand-arc"></div>
        
        <div class="bottom-action-bar">
            <button id="btn-head-play" class="hidden" onclick="headPlay()">æŠ•æ”¾</button>
            <button id="btn-head-reveal" class="hidden" onclick="headReveal()">æ€ç‰Œ</button>
            <button id="btn-follow-play" class="hidden" onclick="followPlay()">è·ŸæŠ•</button>
            <button id="btn-reveal-yes" class="hidden" onclick="revealDecision(true)">æŒ‘æˆ°</button>
            <button id="btn-reveal-no" class="hidden" onclick="revealDecision(false)">æ‚¶ç‰Œ</button>
            <button onclick="sortHand('pattern')">ç‰Œå‹</button>
            <button onclick="sortHand('color')">é¡è‰²</button>
            <button id="btn-reset" class="hidden" onclick="initRound(false)" style="color:var(--accent);">ä¸‹ä¸€å±€</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, runTransaction, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyA15KzswwEHzY_jg2RvFV0T_CAD19EX7MY", authDomain: "hualiaba.firebaseapp.com", databaseURL: "https://hualiaba-default-rtdb.firebaseio.com", projectId: "hualiaba", appId: "1:1066537441904:web:1b5d1c5e4d1b987eb072b5" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'room1');
    let myID, myHand = [], gameState = {}, selectedIdx = [];
    const rankMap = { "ç´…å¸¥":7, "ç´…ä»•":6, "ç´…ç›¸":5, "ç´…ä¿¥":4, "ç´…å‚Œ":3, "ç´…ç‚®":2, "ç´…å…µ":1, "é»‘å°‡":6.5, "é»‘å£«":5.5, "é»‘è±¡":4.5, "é»‘è»Š":3.5, "é»‘é¦¬":2.5, "é»‘åŒ…":1.5, "é»‘å’":0.5 };

    window.join = (id) => {
        const target = `p${id}`;
        runTransaction(ref(db, `room1/seats/${target}`), (curr) => { if (curr === true) return; return true; }).then((res) => {
            if (!res.committed) return alert("ä½ç½®å·²è¢«ä½”ç”¨");
            myID = target;
            document.getElementById('lobby').classList.add('hidden'); document.getElementById('game').classList.remove('hidden');
            onDisconnect(ref(db, `room1/seats/${myID}`)).remove();
            get(gameRef).then(snap => { if(!snap.exists() || !snap.val().phase) initRound(true); });
        });
    };

    onValue(gameRef, (snap) => {
        const d = snap.val(); if(!d) return;
        gameState = d; myHand = d[`${myID}_hand`] || []; updateUI();
    });

    // ç‰Œå‹åˆ¤å®šæ ¸å¿ƒï¼šå€åˆ† ä¸€å°ã€ä¸€å±€ã€3/4/5é¡†
    function getPatternInfo(cards) {
        if (!cards || cards.length === 0) return { name: "ç„¡", power: 0 };
        const n = cards.map(x => x[1]).sort().join('');
        const isRed = cards.every(x => x.includes('ç´…'));
        const isBlack = cards.every(x => x.includes('é»‘'));

        // 1. ä¸€å±€ (ç‰¹æ®Šçµ„åˆ)
        if (n === "ä»•å¸¥ç›¸" || n === "å£«å°‡è±¡") return { name: "ä¸€å±€", power: isRed ? 100 : 95 };
        if (n === "å‚Œä¿¥ç‚®" || n === "åŒ…è»Šé¦¬") return { name: "ä¸€å±€", power: isRed ? 85 : 80 };

        // 2. 3/4/5é¡† (ç´”å…µå’)
        if (cards.length >= 3 && cards.every(x => x[1] === "å…µ" || x[1] === "å’")) {
            return { name: `${cards.length}é¡†`, power: 50 + cards.length };
        }

        // 3. ä¸€å° (å°å­)
        if (cards.length === 2 && cards[0][1] === cards[1][1] && (isRed || isBlack)) {
            return { name: "ä¸€å°", power: 40 + rankMap[cards[0]] };
        }

        // 4. å–®é¡†
        return { name: cards.length === 1 ? "ä¸€é¡†" : "éç‰Œå‹", power: Math.max(...cards.map(x => rankMap[x])) };
    }

    function updateUI() {
        const ph = gameState.phase, table = gameState.table || {};
        document.getElementById('score-ui').innerHTML = [1,2,3,4].map(i => `<div class="score-box">P${i}<br><b>${(gameState.scores?.[`p${i}`]||0) + ((gameState.scores?.[`p${i}`]||0) >= 32 ? 10 : 0)}</b></div>`).join('');
        document.getElementById('counting-phase').className = ph === "COUNTING" ? "" : "hidden";
        
        if(ph === "COUNTING") {
            const picks = gameState.finger_picks || {}; const pickCount = Object.keys(picks).length;
            const missing = [1,2,3,4].filter(i => !picks[`p${i}`]).map(i => "P"+i);
            document.getElementById('diag-msg').innerText = missing.length ? `â³ ç­‰å¾…æŒ‡é‹ï¼š${missing.join(', ')}` : "æ•¸å­—åˆ°é½Šï¼å•Ÿå‹•è¼ªç›¤...";
            if(pickCount === 4 && !gameState.rouletteAnimating && myID === (gameState.dealer || "p1")) resolveHeadAndDeal();
        }

        const activePidForLight = gameState.currentRoulettePid || (ph === "HEAD_PLAYING" ? gameState.head : null);
        document.getElementById('center-num').innerText = gameState.rouletteAnimating ? gameState.rouletteSum : "";

        const dealerBadge = document.getElementById('dealer-badge');
        ["bottom", "left", "top", "right"].forEach(view => {
            const pid = ({"bottom":0,"left":1,"top":2,"right":3}[view] + parseInt(myID?.slice(1)||1) - 1) % 4 + 1;
            const targetPid = `p${pid}`;
            const slot = document.getElementById(`view-${view}`);
            if(targetPid === (gameState.dealer || "p1")) { slot.appendChild(dealerBadge); dealerBadge.classList.remove('hidden'); }
            slot.classList.toggle('active-area', targetPid === activePidForLight);

            slot.querySelector(`.cards-container`).innerHTML = table[targetPid] ? table[targetPid].cards.map(c => {
                const visible = (table[targetPid].revealed || targetPid === myID);
                return `<div class="piece-base ${visible ? (c.includes('ç´…')?'red':'black') : 'covered'}">${visible ? c[1] : '?'}</div>`;
            }).join('') : "";
        });

        // å¼§å½¢æ‰‹ç‰Œæ¸²æŸ“
        const arcContainer = document.getElementById('hand-arc');
        arcContainer.innerHTML = "";
        const radius = 240, selCount = selectedIdx.length, selGap = 55, selStartX = 180 - ((selCount-1)*selGap/2);

        myHand.forEach((p, i) => {
            const el = document.createElement('div');
            const isRed = p.includes('ç´…');
            el.className = `hand-piece ${isRed ? 'red' : 'black'} ${selectedIdx.includes(i)?'selected':''}`;
            el.innerText = p[1];
            el.onclick = () => { const idx = selectedIdx.indexOf(i); if(idx > -1) selectedIdx.splice(idx,1); else selectedIdx.push(i); updateUI(); };
            
            if (selectedIdx.includes(i)) {
                // é¸ä¸­ä½ç½®ä¸‹ç§»å°é½Šæœ€ä½åœ“å¼§
                const pos = selectedIdx.indexOf(i);
                el.style.left = `${selStartX + (pos * selGap) - 26}px`;
                el.style.top = `105px`; el.style.transform = `rotate(0deg) scale(1.1)`;
            } else {
                const angleDeg = 145 - (i * (110 / 7));
                const angleRad = angleDeg * (Math.PI / 180);
                el.style.left = `calc(50% + ${radius * Math.cos(angleRad)}px - 26px)`;
                el.style.top = `${-radius * Math.sin(angleRad) + radius}px`;
                el.style.transform = `rotate(${90 - angleDeg}deg)`;
            }
            arcContainer.appendChild(el);
        });

        const isH = (myID === gameState.head), hasP = !!table[myID];
        document.getElementById('btn-head-play').className = (ph === "HEAD_PLAYING" && isH) ? "action-glow" : "hidden";
        document.getElementById('btn-head-reveal').className = (ph === "HEAD_REVEALING" && isH) ? "action-glow" : "hidden";
        document.getElementById('btn-follow-play').className = (ph === "FOLLOW_PLAYING" && !isH && !hasP) ? "action-glow" : "hidden";
        const rBtn = document.getElementById('btn-reveal-yes');
        if (ph === "REVEAL_DECISION" && !isH && hasP && table[myID]?.decision === "pending") {
            const headP = getPatternInfo(table[gameState.head].cards).power;
            const myP = getPatternInfo(table[myID].cards).power;
            rBtn.className = "action-glow"; rBtn.disabled = myP <= headP; rBtn.innerText = myP > headP ? "æŒ‘æˆ°" : "å¨åŠ›ä¸è¶³";
        } else rBtn.className = "hidden";
        document.getElementById('btn-reveal-no').className = (ph === "REVEAL_DECISION" && !isH && hasP && table[myID]?.decision === "pending") ? "" : "hidden";
        
        if(ph === "HEAD_PLAYING") document.getElementById('diag-msg').innerText = isH ? "ğŸ”¥ è¼ªåˆ°ä½ é¦–ç™¼ï¼" : `ç­‰å¾… ${gameState.head?.toUpperCase()} å‡ºç‰Œ`;
        const allE = !gameState.p1_hand?.length && !gameState.p2_hand?.length && !gameState.p3_hand?.length && !gameState.p4_hand?.length;
        document.getElementById('btn-reset').className = (ph === "FINISHED" || (ph === "HEAD_PLAYING" && allE && gameState.deckCount > 0)) && myID === (gameState.dealer || "p1") ? "" : "hidden";
    }

    async function resolveHeadAndDeal() {
        const snap = await get(gameRef); const d = snap.val();
        const picks = d.finger_picks;
        const sum = Object.values(picks).reduce((a,b) => a+b, 0);
        
        // ä¿®æ­£åˆ¤å®šï¼šåƒ…åœ¨ã€Œæ‰€æœ‰äººåˆ°é½Šä¸”ç¸½å’Œç‚º0ã€æ™‚é‡ä¾†
        if(sum === 0 && Object.keys(picks).length === 4) {
            alert("å…¨å“¡æŒ‡é‹ 0ï¼è«‹é‡æ–°é–‹å§‹ï¼");
            update(gameRef, { finger_picks: null });
            return;
        }

        await update(gameRef, { rouletteAnimating: true, rouletteSum: sum });
        let currentIdx = parseInt((d.dealer || "p1").slice(1));
        for(let i = 1; i <= sum; i++) {
            await update(gameRef, { currentRoulettePid: `p${currentIdx}` });
            await new Promise(r => setTimeout(r, 220)); 
            currentIdx = (currentIdx % 4) + 1;
        }

        const headID = `p${(((parseInt((d.dealer||"p1").slice(1)) + sum - 2) % 4) + 4) % 4 + 1}`;
        const p = ["ç´…å¸¥","ç´…ä»•","ç´…ä»•","ç´…ç›¸","ç´…ç›¸","ç´…ä¿¥","ç´…ä¿¥","ç´…å‚Œ","ç´…å‚Œ","ç´…ç‚®","ç´…ç‚®","ç´…å…µ","ç´…å…µ","ç´…å…µ","ç´…å…µ","ç´…å…µ","é»‘å°‡","é»‘å£«","é»‘å£«","é»‘è±¡","é»‘è±¡","é»‘è»Š","é»‘è»Š","é»‘é¦¬","é»‘é¦¬","é»‘åŒ…","é»‘åŒ…","é»‘å’","é»‘å’","é»‘å’","é»‘å’","é»‘å’"];
        const s = p.sort(() => Math.random() - 0.5);
        update(gameRef, { phase: "HEAD_PLAYING", head: headID, table: {}, finger_picks: null, rouletteAnimating: false, currentRoulettePid: null, p1_hand: s.slice(0, 8), p2_hand: s.slice(8, 16), p3_hand: s.slice(16, 24), p4_hand: s.slice(24, 32) });
    }

    window.initRound = (isFull) => {
        const dCount = isFull ? 1 : (gameState.deckCount || 1) + 1;
        const sc = isFull ? {p1:0,p2:0,p3:0,p4:0} : (gameState.scores || {p1:0,p2:0,p3:0,p4:0});
        update(gameRef, { phase: "COUNTING", table: {}, finger_picks: {}, scores: sc, deckCount: dCount, dealer: isFull ? "p1" : ({"p1":"p2","p2":"p3","p3":"p4","p4":"p1"}[gameState.dealer || "p1"]), p1_hand:[], p2_hand:[], p3_hand:[], p4_hand:[] });
    };
    window.submitFinger = () => { update(gameRef, { [`finger_picks/${myID}`]: parseInt(document.getElementById('finger-num').value) }); };
    window.headPlay = () => { update(gameRef, { phase: "FOLLOW_PLAYING", [`table/${myID}`]: { cards: selectedIdx.map(i=>myHand[i]), revealed: false, decision: "reveal" }, [`${myID}_hand`]: myHand.filter((_, i) => !selectedIdx.includes(i)) }); selectedIdx = []; };
    window.followPlay = () => {
        const need = gameState.table[gameState.head].cards.length;
        if(selectedIdx.length !== need) return alert(`éœ€æŠ• ${need} é¡†`);
        update(gameRef, { [`table/${myID}`]: { cards: selectedIdx.map(i=>myHand[i]), revealed: false, decision: "pending" }, [`${myID}_hand`]: myHand.filter((_, i) => !selectedIdx.includes(i)) }).then(() => {
            get(gameRef).then(s => { if(Object.keys(s.val().table || {}).length === 4) update(gameRef, { phase: "HEAD_REVEALING" }); });
        });
        selectedIdx = [];
    };
    window.headReveal = () => { update(gameRef, { phase: "REVEAL_DECISION", [`table/${gameState.head}/revealed`]: true }); };
    window.revealDecision = (res) => {
        update(gameRef, { [`table/${myID}/decision`]: res ? "reveal" : "muffle", [`table/${myID}/revealed`]: !!res }).then(() => {
            get(gameRef).then(s => {
                const d = s.val(); let dc = 0; Object.values(d.table).forEach(p => { if(p.decision !== "pending") dc++; });
                if(dc === 4) { update(gameRef, { phase: "RESOLVING" }); setTimeout(() => resolveWinner(d), 1500); }
            });
        });
    };
    function resolveWinner(d) {
        let win = d.head, max = -1;
        Object.keys(d.table).forEach(pid => { const p = d.table[pid]; if(p?.decision === "reveal") { const pw = getPatternInfo(p.cards).power; if(pw > max) { max = pw; win = pid; } } });
        const ns = d.scores || {p1:0, p2:0, p3:0, p4:0}; ns[win] += (d.table[d.head]?.cards?.length || 0) * 4;
        update(gameRef, { phase: (!d.p1_hand?.length && !d.p2_hand?.length && !d.p3_hand?.length && !d.p4_hand?.length) ? "FINISHED" : "HEAD_PLAYING", head: win, table: {}, scores: ns, dealer: d.dealer || "p1" });
    }
    window.sortHand = (t) => {
        const o = {"å¸¥":1,"å°‡":1,"ä»•":2,"å£«":2,"ç›¸":3,"è±¡":3,"ä¿¥":4,"è»Š":4,"å‚Œ":5,"é¦¬":5,"ç‚®":6,"åŒ…":6,"å…µ":7,"å’":7};
        if(t === 'pattern') myHand.sort((a,b) => (o[a[1]]||99)-(o[b[1]]||99) || a[0].localeCompare(b[0]));
        else if(t === 'color') myHand.sort((a,b) => (a.includes('ç´…') ? 0 : 1) - (b.includes('ç´…') ? 0 : 1) || (o[a[1]]||99)-(o[b[1]]||99));
        update(gameRef, { [`${myID}_hand`]: myHand });
    };
    window.forceCleanDatabase = () => { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) remove(gameRef).then(() => location.reload()); };
</script>
</body>
</html>
